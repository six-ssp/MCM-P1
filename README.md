
---

# Q2（第二问）代码与图表说明（对应解答文档）

> 本部分严格承接第一问的 SOC 动力学模型，并在此基础上引入**等效电路模型（ECM）+ 热模型 + 终止条件**，对不同使用场景下手机电池的**放电寿命 (t_{\text{empty}})** 进行仿真与对比，并通过多种图形从“轨迹、损失、功耗、能量、对比、敏感性、不确定性”等角度解释结果。

---

## 1. 核心建模思路（代码整体框架）

第二问的整体思路可以概括为：

1. **功耗结构建模**：根据场景参数生成瞬时功耗 (P(t))，由基础功耗 + 屏幕 + CPU + 网络 + GPS 组成；
2. **承接 Q1 的 SOC 动力学**：将功耗转化为 SOC 的下降；
3. **引入 ECM 等效电路（(V_{\text{oc}})、(R_0)、两支 RC）**：由电流计算端电压 (V_{\text{term}})，并分解电压损失来源；
4. **热模型**：由电池发热与散热更新温度 (T(t))；
5. **三重终止条件（事件触发）**：SOC 到下限、电压到截止、温度超上限，取最先触发的时刻为 (t_{\text{empty}})；
6. **蒙特卡洛不确定性**：对关键参数做 ±10% 扰动，得到寿命分布与置信区间；
7. **输出：单场景解释图 + 跨场景对比图 + 汇总 CSV 表**。

---

## 2. 关键数学模型（对应解答文档）

### 2.1 功耗结构（来自文档“功耗组成/模块功耗”）

瞬时功耗由多个模块叠加：

$$
P(t)=P_{\text{base}}+P_{\text{screen}}(t)+P_{\text{cpu}}(t)+P_{\text{net}}(t)+P_{\text{gps}}(t).
$$

其中各项由场景参数（亮度、占空比、CPU 使用率、网络类型等）决定。代码中用**平滑占空比**近似“间歇使用”，避免硬方波导致图形锯齿误解，但不改变寿命判断逻辑。

---

### 2.2 SOC 动力学（严格承接 Q1）

第一问给出的连续时间 SOC 模型为：

$$
\frac{d,SOC(t)}{dt}=-\frac{P(t)}{C_{\text{eff}}}.
$$

本代码严格采用同一形式，并使用相同容量参数（与 Q1 保持一致）：

* (C_{\text{eff}}=17.0\ \text{Wh})

---

### 2.3 等效电路 ECM（对应文档“开路电压 + 欧姆内阻 + 两个 RC 支路”）

端电压由开路电压减去欧姆压降与极化电压：

$$
V_{\text{term}}(t)=V_{\text{oc}}(SOC,T)-I(t)R_0(SOC,T,SOH)-V_1(t)-V_2(t).
$$

其中两组 RC 支路（快/慢极化）满足一阶动态：

$$
\frac{dV_1}{dt}=-\frac{V_1}{R_1C_1}+\frac{I}{C_1},\qquad
\frac{dV_2}{dt}=-\frac{V_2}{R_2C_2}+\frac{I}{C_2}.
$$

（代码里将秒单位常数换算到小时单位，以保证与 (t) 的单位一致。）

电流由功耗与估计端电压确定：

$$
I(t)\approx \frac{P(t)}{V_{\text{term}}(t)}.
$$

---

### 2.4 热模型（对应文档“温升/散热”）

温度变化采用集总模型：发热来自欧姆损耗和极化耗散，散热近似线性对流：

$$
\frac{dT}{dt}=\frac{P_{\text{heat}}}{C_{\text{th}}}-\frac{k_{\text{cool}}(T-T_{\text{amb}})}{C_{\text{th}}},
$$

其中：

$$
P_{\text{heat}}=I^2R_0 + I V_1 + I V_2.
$$

---

### 2.5 终止条件与寿命定义（对应文档“事件触发/关机条件”）

将寿命定义为最先触发的终止条件时刻：

$$
t_{\text{empty}}=\min{t:\ SOC(t)\le SOC_{\min}\ \ \text{or}\ \ V_{\text{term}}(t)\le V_{\text{cutoff}}\ \ \text{or}\ \ T(t)\ge T_{\max}}.
$$

代码中使用三条阈值：

* (SOC_{\min}=5%)
* (V_{\text{cutoff}}=3.0\ \text{V})
* (T_{\max}=45^\circ\text{C})

---

## 3. 输出文件与图表说明（你生成的所有内容是干什么的）

运行脚本后会自动生成一系列 PNG 图和一份 CSV 汇总表。以下说明与解答文档的叙事顺序一致。

---

# A. 单场景输出图（每个场景都会生成一套）

场景包含：

* S1 / S2 / S3 / S4（主场景）
* S5a~S5e（敏感性场景，用于 Tornado 图）

每个场景会生成 4 张图：

---

## 3.1 `S*_Q2-1_main.png` —— **主轨迹图：SOC & 端电压 + 阈值 + 寿命解释**

**图中包含：**

* 左轴：SOC(%) 轨迹
* 右轴：端电压 (V_{\text{term}}(t)) 轨迹
* 两条阈值线：(SOC_{\min})、(V_{\text{cutoff}})
* 一条竖线：(t_{\text{empty}})
* 文本标注：关机原因（SOC 先到 / 电压先到 / 温度先到）

**用于回答：**

* “这个场景下电池能撑多久？”
* “关机是因为 SOC 用完还是电压先掉到截止？”
* “端电压为什么会提前掉到 3.0V（等效电路效应）？”

**对应文档位置：**

* 寿命定义 + 终止条件（事件触发）
* ECM 输出端电压

---

## 3.2 `S*_Q2-2_drop.png` —— **电压损失分解图：R0、IR0、V1、V2、V1+V2**

该图将端电压中的损失项单独拿出来看：

* 欧姆内阻：(R_0(t))
* 欧姆压降：(I(t)R_0(t))
* 极化压降：(V_1(t))、(V_2(t))、(V_1(t)+V_2(t))

**用于回答：**

* “电压下降到底主要来自哪一部分？”
* “是内阻（老化/低温）导致的 IR0 增大？”
* “还是极化（RC 支路）导致电压动态下沉？”

**对应文档位置：**

* 等效电路结构（(V_{\text{oc}},R_0,R_1C_1,R_2C_2)）
* 电压表达式与压降来源分析

---

## 3.3 `S*_Q2-3_power_stack.png` —— **功耗堆叠图：功耗结构随时间变化**

把功耗拆成模块并做堆叠：

* Base / Screen / CPU / Network / GPS

**用于回答：**

* “该场景的功耗主要来自屏幕还是 CPU？”
* “网络模块功耗是否在某些时段显著贡献？”
* “解释为什么某些场景寿命更短（功耗整体抬高）”

**对应文档位置：**

* 功耗结构/模块功耗假设
* 将功耗输入 SOC ODE

> 说明：该图做了**下采样**以避免非常密集的占空比导致“竖条墙”，更利于交稿阅读。

---

## 3.4 `S*_Q2-4_energy_pie.png` —— **能量占比饼图：谁“吃掉”了电量**

对各模块功耗做时间积分，得到能量消耗：

$$
E_k=\int_0^{t_{\text{empty}}} P_k(t),dt,\qquad
E_{\text{total}}=\sum_k E_k.
$$

饼图显示各模块 (E_k/E_{\text{total}}) 的比例。

**用于回答：**

* “最终电量主要花在屏幕还是 CPU？”
* “为什么 S2（游戏）寿命显著更短？（CPU+Screen 能量占比更大）”
* 作为堆叠功耗图的“总结视角”，更适合写结论段。

**对应文档位置：**

* 功耗分解 + 能量解释

---

# B. 跨场景对比图（全局图）

---

## 3.5 `Q2-5_energy_3Dbar.png` —— **3D 能量柱状对比：场景 × 模块 × Wh**

三维柱状图展示：

* X：场景（S1~S5）
* Y：模块（Base/Screen/CPU/Network/GPS）
* Z：能量消耗（Wh）

**用于回答：**

* “不同场景下，能量结构差异是什么？”
* “哪个模块在某场景显著抬升？”
* 这张图非常适合放在“跨场景对比”章节里做总览。

---

## 3.6 `Q2-6_t_empty_comparison.png` —— **寿命对比柱状：(t_{\text{empty}}) + 关机原因**

柱状图高度为 (t_{\text{empty}})，并用颜色编码关机原因：

* SOC_min（SOC 先触发）
* V_cutoff（电压截止先触发）
* Thermal（温度先触发）

**用于回答：**

* “哪个场景寿命最长/最短？”
* “短的原因是什么（功耗大 vs 内阻大导致电压先掉）？”
* 是第二问最核心的“结果图”。

---

## 3.7 `Q2-8_shutdown_reason_share.png` —— **关机原因占比饼图（所有场景）**

统计各场景的关机原因占比：

* 有多少是 SOC 先到 5%？
* 有多少是电压先掉到 3.0V？
* 是否出现热保护？

**用于回答：**

* “总体上系统更容易被哪个阈值限制？”
* “文档假设下，电压限制是否常见？”

---

## 3.8 `Q2-9_S5_tornado.png` —— **敏感性 Tornado：相对 S1 的寿命变化**

对 S5 系列（单变量变化）计算：

$$
\Delta t_{\text{empty}} = t_{\text{empty}}(\text{S5}) - t_{\text{empty}}(\text{S1}).
$$

横轴为 (\Delta t_{\text{empty}})，纵轴为不同敏感性场景。

**用于回答：**

* “温度变冷/变热对寿命影响多大？”
* “SOH 下降对寿命影响多大？”
* “亮度/网络变化是否关键？”
* 这是非常标准的 MCM 风格敏感性分析图。

---

## 3.9 `Q2-10_MC_boxplot.png` —— **蒙特卡洛不确定性箱线图：寿命分布**

文档要求蒙特卡洛：对关键参数做 ±10% 扰动，得到 (t_{\text{empty}}) 的分布。
箱线图展示各场景寿命的不确定性区间。

配套 CSV 中也会给出：

* P10 / P50 / P90（10%、50%、90% 分位数）

**用于回答：**

* “结论是否稳健？”
* “某场景寿命不确定性是否更大？”
* “模型参数波动下结果区间范围？”

---

# C. 表格输出（用于写正文/汇总）

---

## 3.10 `Q2_summary_table.csv` —— **第二问汇总表（写论文/做表格用）**

每一行对应一个场景，包含：

* 场景参数（SOC0, T_amb, SOH）
* 寿命：`t_empty(h)`
* 关机原因：`ShutdownReason`
* 终止时的状态：`SOC_end(%)`, `Vterm_end(V)`, `T_end(C)`
* 若开了蒙特卡洛：`MC_p10(h)`, `MC_p50(h)`, `MC_p90(h)`

**用途：**

* 你可以直接把这张表在正文里做“Table 1：Scenario results”
* 或者把 `t_empty`、`ShutdownReason` 做成结论段的关键数据引用
* 也可用来做后续问题（比如第三问优化/策略）时的基准对照

---

## 4. 代码模块对应关系（解答文档 → 代码实现）

| 文档模块        | 代码实现位置（逻辑）                                                  | 作用                         |
| ----------- | ----------------------------------------------------------- | -------------------------- |
| 功耗分解 (P(t)) | `power_components()`                                        | 生成 Base/Screen/CPU/Net/GPS |
| SOC 下降 ODE  | `dSOC_dt = -P/C_eff_Wh`                                     | 承接第一问                      |
| ECM 输出电压    | `Voc(), R0(), rc_params()` + `Vterm = voc - I*R0 - V1 - V2` | 端电压与压降分解                   |
| 两 RC 极化     | `dV1_dt, dV2_dt`                                            | 快/慢极化动态                    |
| 热模型         | `dT_dt`                                                     | 温升、散热、热保护                  |
| 三终止条件       | `make_events()`                                             | SOC、电压、温度触发                |
| 蒙特卡洛 ±10%   | `monte_carlo_t_empty()`                                     | 置信区间 + 箱线图                 |

---

## 5. 如何在正文里引用这些图（推荐顺序）

建议你第二问写作时按如下结构插图：

1. **Q2-1（Main）**：先展示一个典型场景轨迹，定义 (t_{\text{empty}}) 与关机原因
2. **Q2-2（Drop）**：解释为什么电压会先到 3.0V（IR0/极化项）
3. **Q2-3 + Q2-4（Power + Pie）**：解释能量从哪里被消耗（功耗结构→能量占比）
4. **Q2-6（t_empty 对比）**：给出跨场景寿命结论（最关键对比图）
5. **Q2-9（Tornado）**：敏感性分析（哪些因素影响最大）
6. **Q2-10（MC）**：不确定性分析（结论稳健性）

---
