# 第二问（Q2）仿真与出图说明（

> 本节对应解答文档的**Q2：等效电路 + 热模型 + 终止条件 + 场景对比 + 不确定性（蒙特卡洛）**。
> 代码文件：`p2_submit.py`（或当前的 `p2_other.py` 改进版）。
> 输出文件：若干 `png` 图 + `Q2_summary_table.csv` 汇总表。
> 
> 

---

# 1. 模型与核心方程（承接第一问）

## 1.1 SOC 动力学（承接 Q1）

电量以等效容量 \(C_{\mathrm{eff}}\)（单位 Wh）计，功耗为 \(P(t)\)（单位 W），则 SOC 的连续时间模型为：

 $\frac{d\,SOC(t)}{dt}=-\frac{P(t)}{C_{\mathrm{eff}}},\qquad C_{\mathrm{eff}}=17.0\ \mathrm{Wh}$ 

> 解释：这是第一问最简 ODE 的直接延续。Q2 中 **唯一的区别**是 \(P(t)\) 不再简单给定，而是来自“屏幕/CPU/网络/GPS”等模块功耗结构，并通过等效电路进一步影响端电压与终止条件。
> 
> 

---

## 1.2 等效电路（ECM）与端电压

电池等效电路包含：

- 开路电压源： $V_{\mathrm{oc}}(SOC,T)$ 

- 欧姆内阻： $R_0(SOC,T,SOH)$ 

- 两组 RC 支路极化电压： $V_1(t),V_2(t)$ （分别对应快/慢极化过程）

端电压（放电）写作：

 $V_{\mathrm{term}}(t)=V_{\mathrm{oc}}(SOC,T)-I(t)\,R_0(SOC,T,SOH)-V_1(t)-V_2(t)$ 

其中电流由功耗与估计端电压决定：

 $I(t)\approx \frac{P(t)}{\max\{V_{\mathrm{oc}}-V_1-V_2,\,3.0\}}$ 

RC 极化一阶动态（以小时为时间单位，代码中做了秒↔小时的换算）：

 $\frac{dV_1}{dt}=-\frac{V_1}{\tau_1}+k_1\,I(t),\qquad \frac{dV_2}{dt}=-\frac{V_2}{\tau_2}+k_2\,I(t)$ 

> 解释：这部分负责把“功耗”映射为“端电压下降曲线”，从而解释为什么某些场景会先触发电压截止。
> 
> 

---

## 1.3 热模型（集总热容）

考虑由内阻和极化产生的发热（简化写法）：

 $P_{\mathrm{heat}}(t)\approx I(t)^2 R_0 + I(t)V_1 + I(t)V_2$ 

温度动力学（集总热容 + 对流散热）：

 $\frac{dT}{dt}=\frac{P_{\mathrm{heat}}}{C_{\mathrm{th}}}-\frac{k_{\mathrm{cool}}}{C_{\mathrm{th}}}\bigl(T-T_{\mathrm{amb}}\bigr)$ 

> 解释：热模型用来支持 “**温度上限终止**” 这一类场景分析（例如高温/高负载）。
> 
> 

---

## 1.4 三个终止条件（决定 \(t_{\mathrm{empty}}\)）

仿真在满足任一条件时停止（取最先触发者）：

- **SOC 下限**： $SOC(t)\le SOC_{\min}=5\%$ 

- **电压截止**： $V_{\mathrm{term}}(t)\le V_{\mathrm{cutoff}}=3.0\,\mathrm{V}$ 

- **温度保护**： $T(t)\ge T_{\max}=45^\circ\mathrm{C}$ 

定义电池可用时长：

 $t_{\mathrm{empty}}=\min\{t:\ SOC\le SOC_{\min}\ \text{or}\ V_{\mathrm{term}}\le V_{\mathrm{cutoff}}\ \text{or}\ T\ge T_{\max}\}$ 

---

# 2. 功耗结构 \(P(t)\) 的组成（对应文档“功耗分解/模块功耗”）

代码将手机功耗分解为 5 个部分并求和：

 $P(t)=P_{\mathrm{base}}+P_{\mathrm{screen}}(t)+P_{\mathrm{cpu}}(t)+P_{\mathrm{net}}(t)+P_{\mathrm{gps}}(t)$ 

- `Base`：待机/系统底耗  $P_{\mathrm{base}}$ 

- `Screen`：屏幕功耗（亮度  $B$  与亮屏占空比控制）

- `CPU`：CPU/算力负载功耗（随  $U_{\mathrm{cpu}}$  变化）

- `Network`：网络功耗（4G/5G/WiFi 与占空比控制）

- `GPS`：GPS 开关

> 
> 

---

# 3. 生成的图分别在讲什么（逐图对应文档叙事）

> 文件命名规则：
> - 单场景图：`S1_Q2-1_main.png`、`S2_Q2-2_drop.png` … 
> - 全场景对比图：`Q2-6_t_empty_comparison.png` 等
> 
> 

---

## 3.1 `*_Q2-1_main.png` —— 主轨迹图（SOC & 端电压 + 阈值 + 终止时刻）

### 展示内容：

- 左轴：SOC(%) 随时间下降曲线

- 右轴：端电压 \(V_{\mathrm{term}}\) 随时间变化曲线（做了轻微平滑）

- 两条虚线阈值：
  - `SOC_min = 5%` 
  - `V_cutoff = 3.0V`

- 一条竖虚线：**\(t_{\mathrm{empty}}\)**（最先触发的终止时刻）

- 左下角文字：输出 `t_empty` 与终止原因（SOC/电压/温度）

### 它回答的问题：

- “这个场景电池能撑多久？”

- “到底是 SOC 先耗尽，还是电压先掉到截止，或者温度先超限？”

---

## 3.2 `*_Q2-2_drop.png` —— 电压损失分解图（ECM 解释电压为何下降）

### 展示内容：

-  $R_0(t)$ （欧姆内阻）

-  $I(t)R_0(t)$ （欧姆压降）

-  $V_1(t)$ 、 $V_2(t)$ （快/慢极化电压）

-  $V_1(t)+V_2(t)$ （总极化压降）

### 它回答的问题：

- “端电压下降主要由哪个部分导致？”

- “该场景为何会早早触发**3.0V 截止**（如果确实是电压触发）？”

---

## 3.3 `*_Q2-3_power_stack.png` —— 功耗堆叠图（模块功耗结构随时间）

### 展示内容：

- 用 stackplot 显示 `Base/Screen/CPU/Network/GPS` 五部分功耗叠加

- 代码做了下采样，避免密集脉冲造成“竖条墙”不易读

### 它回答的问题：

- “这个使用场景下功耗结构是什么？”

- “是屏幕耗电为主？还是 CPU/网络为主？”

- 为后续能量占比与寿命差异提供解释依据。

---

## 3.4 `*_Q2-4_energy_pie.png` —— 能量占比饼图（比堆叠图更适合写结论）

### 展示内容：

- 对每个模块功耗 \(P_k(t)\) 做时间积分得到能量 \(E_k\)（Wh）：
 $E_k=\int_0^{t_{\mathrm{empty}}} P_k(t)\,dt$ 

- 饼图显示各模块能量占比（%）

- 图下方给出总能量消耗（Wh）

### 它回答的问题：

- “在整个放电过程中，究竟是谁吃掉了最多电量？”

- 饼图常用于论文/报告的结论句：
  “Screen accounts for xx%, CPU accounts for yy% …”

---

## 3.5 `Q2-5_energy_3Dbar.png` —— 全场景能量 3D 柱（场景×模块×能量）

### 展示内容：

- x 轴：场景（S1/S2/S3/S4/S5a~e）

- y 轴：模块（Base/Screen/CPU/Network/GPS）

- z 轴：能量（Wh）

- 3D 柱状更直观展示“不同场景下不同模块能量的变化”

### 它回答的问题：

- “哪种场景是 CPU 主导？哪种是网络主导？”

- “S3（导航+5G）为什么比 S1 更耗电？耗在哪里？”

---

## 3.6 `Q2-6_t_empty_comparison.png` —— 各场景续航对比柱状图（颜色=终止原因）

### 展示内容：

- 每个场景的  $t_{\mathrm{empty}}$ （小时）柱状图

- 柱子颜色表示终止原因（SOC/电压/温度/到达最大仿真时长）

### 它回答的问题：

- “最重要的最终结论：不同场景能用多久？”

- “寿命差异是由哪类终止条件决定？”

> 这是 Q2 最关键的“结论图”，建议正文中优先引用。
> 
> 

---

## 3.7 `Q2-8_shutdown_reason_share.png` —— 终止原因占比饼图（全场景总结）

### 展示内容：

- 汇总所有场景的终止原因（SOC/电压/温度）的占比

### 它回答的问题：

- “整体来看，本模型里最常见的失效机制是什么？”

- “电压截止是不是比 SOC 先耗尽更常见？”

---

## 3.8 `Q2-9_S5_tornado.png` —— 敏感性 Tornado 图（S5：单变量扰动对续航影响）

### 展示内容：

- 以 S1 为基准，比较 S5a~S5e 的变化：
 $\Delta t_{\mathrm{empty}}=t_{\mathrm{empty}}(S5)-t_{\mathrm{empty}}(S1)$ 

- 横轴：续航变化（小时）

- 纵轴：敏感性场景（如温度变化、SOH下降、亮度升高、网络关闭）

### 它回答的问题：

- “最影响续航的因素是什么？”

- “温度 vs 老化（SOH） vs 亮度，哪个更关键？”

---

## 3.9 `Q2-10_MC_boxplot.png` —— 蒙特卡洛不确定性箱线图（对应文档 MC）

### 展示内容：

- 对参数做  $\pm 10\%$  扰动（文档要求），重复 $N=500$  次，得到  $t_{\mathrm{empty}}$ 分布

- 箱线图显示各场景  $t_{\mathrm{empty}}$  的不确定性范围

- 同时在 `Q2_summary_table.csv` 里保存了 p10/p50/p90

### 它回答的问题：

- “结论稳不稳？”

- “哪个场景对参数不确定性更敏感？”

---

# 4. 生成的表格文件是干什么的？

## 4.1 `Q2_summary_table.csv` —— 全场景指标汇总表（写报告最有用）

该 CSV 用于论文/报告中的“表 1/表 2”，包含字段如：

- 场景名、初始 SOC、环境温度、SOH

-  $t_{\mathrm{empty}}$ （续航）

- 终止原因（SOC/电压/温度）

- 终止时刻的 SOC、端电压、温度

- 蒙特卡洛分位数（p10 / p50 / p90）

> 用法：可以直接把 CSV 导入 Excel，做“表格 + 二次可视化”。
> 
> 

---

# 5. 代码大体思路（从输入到输出）

1. **定义场景参数**（S1~S4 + S5 敏感性）
含  $T_{\mathrm{amb}}, SOH, SOC_0, B, U_{\mathrm{cpu}},$  网络类型与占空比等。

2. **构造功耗模型 \(P(t)\)**
将功耗拆成 5 部分，并用占空比门控函数形成时间变化。

3. **建立 ODE 系统**（状态：SOC、V1、V2、T、SOH）
- SOC：由  $P(t)$  驱动（承接 Q1）
- V1/V2：RC 极化
- T：热模型

4. **加入事件终止条件**（SOC、电压、温度）
数值积分时自动在最先触发处停止，得到  $t_{\mathrm{empty}}$  与原因。

5. **后处理生成曲线**（I、Vterm、IR0、V1+V2、功耗分解）

6. **出图**：单场景 + 全场景对比图

7. **蒙特卡洛**：参数  $\pm 10\%$  扰动，重复  $N=500$  得到分布与分位数

8. **导出 CSV 汇总表**：便于写报告与复核。

---

# 6. 建议的正文引用顺序（写 Q2 最稳）

1. 先给 **Q2-6**（全场景续航结论）

2. 再挑典型场景给 **Q2-1**（主轨迹：SOC/电压/终止原因）

3. 用 **Q2-2** 解释“为什么电压会先触发/为什么不会”

4. 用 **Q2-4**（饼图）给一句“能量消耗主要来自……”

5. 最后用 **Q2-9 + Q2-10** 做“敏感性与不确定性”收尾（很像竞赛论文结构）

---
